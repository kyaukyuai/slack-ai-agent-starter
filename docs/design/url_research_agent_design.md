# URL Research Agentの設計書

## 要件定義書

### 概要
URL Research Agentは、指定されたURLのコンテンツを取得し、そのコンテンツを分析して構造化されたレポートを生成するシステムです。このエージェントは、URLコンテンツの理解に加えて、必要に応じて追加のWeb検索を行い、包括的で情報価値の高いレポートを作成します。

### 主要機能
1. URLからのコンテンツ取得
2. コンテンツ分析とレポート計画の生成
3. 追加情報のための検索クエリ生成
4. Web検索の実行
5. レポートセクションの執筆
6. 最終レポートのコンパイル

### 入出力仕様
- **入力**: URL
- **出力**: 構造化されたJSONレポート（タイトル、要約、セクション、引用、参考文献などを含む）

### 非機能要件
- 日本語でのレポート生成
- 同期処理による実行
- LangGraphを使用したワークフロー管理
- LangChainを使用したLLM連携

## 設計書

### システム概略設計

URL Research Agentは、LangGraphを使用して複数のステップから成るワークフローを構築しています。各ステップは特定の機能を担当し、それらが連携してURLコンテンツの分析からレポート生成までの一連のプロセスを実行します。

#### 処理フロー
1. URLからコンテンツを取得
2. レポート計画用の検索クエリを生成
3. Web検索を実行
4. レポート計画（セクション構成）を生成
5. 各セクションについて：
   a. 検索クエリを生成
   b. Web検索を実行
   c. セクションを執筆
6. 研究が不要なセクションを執筆
7. 最終レポートをコンパイル

### 機能設計

#### 1. コンテンツ取得機能
- **役割**: URLからコンテンツを取得し、初期状態を設定
- **主要コンポーネント**: `content_fetcher.py`
- **処理内容**:
  - Firecrawl APIを使用してURLからマークダウン形式のコンテンツを取得
  - タイトル、メタデータなどの基本情報を抽出
  - レポート状態の初期化

#### 2. クエリ生成機能
- **役割**: コンテンツ分析と追加情報収集のための検索クエリを生成
- **主要コンポーネント**: `query_generator.py`
- **処理内容**:
  - レポート全体のための検索クエリ生成
  - 各セクションのための検索クエリ生成
  - レポート計画（セクション構成）の生成

#### 3. 検索機能
- **役割**: 生成されたクエリを使用してWeb検索を実行
- **主要コンポーネント**: `search.py`
- **処理内容**:
  - Tavily SearchまたはPerplexity Search APIを使用した検索実行
  - 検索結果の重複排除と整形

#### 4. セクション執筆機能
- **役割**: 検索結果とURLコンテンツに基づいてレポートセクションを執筆
- **主要コンポーネント**: `section_writer.py`
- **処理内容**:
  - 研究が必要なセクションの執筆
  - 研究が不要なセクションの執筆
  - セクション品質の評価と必要に応じた追加検索

#### 5. レポートコンパイル機能
- **役割**: 執筆されたセクションを統合し、最終レポートを生成
- **主要コンポーネント**: `report_compiler.py`
- **処理内容**:
  - セクションの統合
  - タイトル、要約、ダイジェストの生成
  - 読了時間の推定
  - 最終レポートのJSON形式での出力

### クラス構成

#### データモデル
- **SearchQuery**: 検索クエリを表現
- **Section**: レポートのセクションを表現（見出し、説明、内容、引用、参考文献）
- **Reference**: 参考文献情報
- **SectionOutput**: セクション出力形式
- **InputContent**: URL入力コンテンツ
- **ReportState**: レポート生成の状態管理
- **SectionState**: セクション処理の状態管理

#### グラフ構成
- **メイングラフ**: URLリサーチの全体フロー
  - 前処理（URLコンテンツ取得）
  - レポート計画生成
  - セクション執筆
  - 最終レポートコンパイル

- **セクションビルダーサブグラフ**: 個別セクションの処理
  - クエリ生成
  - Web検索
  - セクション執筆

## 実装の詳細

### 主要コンポーネントの実装

#### 1. グラフビルダー
`graph_builder.py`はLangGraphを使用してワークフローを構築します。メイングラフとセクションビルダーサブグラフの2つのグラフを定義し、それらを連携させています。

#### 2. コンテンツフェッチャー
`content_fetcher.py`はFirecrawl APIを使用してURLからコンテンツを取得し、初期状態を設定します。

#### 3. クエリジェネレーター
`query_generator.py`はLLMを使用して検索クエリを生成します。レポート全体のクエリとセクションごとのクエリを生成する機能があります。

#### 4. 検索
`search.py`はTavily SearchまたはPerplexity Search APIを使用してWeb検索を実行します。

#### 5. セクションライター
`section_writer.py`はLLMを使用してレポートセクションを執筆します。URLコンテンツと検索結果を入力として使用します。

#### 6. レポートコンパイラー
`report_compiler.py`は執筆されたセクションを統合し、タイトル、要約、ダイジェストなどを生成して最終レポートをJSON形式で出力します。

### 同期処理の実装
`sync_url_research_agent.py`は同期バージョンのURLリサーチエージェントを提供します。LangGraphを使用してワークフローを構築し、エクスポートします。

### ユーティリティ関数
`utils.py`はセクションのフォーマット、設定値の取得、JSON処理などのユーティリティ関数を提供します。

## 出力形式

最終的なレポートは以下のJSON形式で出力されます：

```json
{
  "input": {
    "url": "元のURL",
    "title": "元のページタイトル",
    "metadata": {}
  },
  "title": "生成されたレポートタイトル",
  "image_url": "",
  "micro": "60-80文字の要約",
  "digest": ["要約行1", "要約行2", "要約行3"],
  "importance": 0.85,
  "sections": [
    {
      "headline": "セクション1の見出し",
      "content": "セクション1の本文",
      "quotes": [
        {
          "text": "引用テキスト",
          "source": "引用元",
          "relevance": 0.9
        }
      ],
      "references": [
        {
          "title": "参考文献タイトル",
          "url": "参考文献URL",
          "metadata": {}
        }
      ]
    }
  ],
  "readState": "unread",
  "estimatedMinutes": 5,
  "createdAt": "2025-04-26T08:20:42Z"
}
```

**注意**: 最終的なアウトプットからは `input.markdown` フィールドは除外されます。これは、URLコンテンツの生のマークダウンデータが大きくなる可能性があり、最終レポートには不要なためです。

## まとめ

URL Research Agentは、URLコンテンツの分析と追加のWeb検索を組み合わせて、構造化された包括的なレポートを生成するシステムです。LangGraphを使用したワークフロー管理とLangChainを使用したLLM連携により、複雑なタスクを段階的に処理し、高品質なレポートを生成します。

このエージェントは、情報収集、分析、レポート生成のプロセスを自動化し、ユーザーが指定したURLに関する深い洞察を提供します。日本語でのレポート生成に対応しており、タイトル、要約、セクション、引用、参考文献などを含む構造化されたJSONレポートを出力します。
